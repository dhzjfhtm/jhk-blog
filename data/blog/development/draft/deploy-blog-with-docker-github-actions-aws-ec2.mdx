---
title: 'Docker, Github Actions and AWS EC2로 블로그 자동 배포하기(1)'
date: '2023-10-04'
tags: ['blog', 'docker', 'github', 'aws', 'ec2']
draft: true
summary: ''
---

# Docker, Github Actions and AWS EC2로 블로그 자동 배포하기(1)

## 1. 들어가며

이번 포스팅에서는 Docker, Github Actions, AWS EC2를 이용하여 블로그를 자동 배포하는 방법에 대해 알아보겠습니다.

## 2. Docker

### 2.1 Docker란?

Docker는 컨테이너 기반의 오픈소스 가상화 플랫폼입니다. 컨테이너 기반의 가상화는 기존의 가상화 방식과 달리 OS를 가상화하는 것이 아닌 프로세스를 격리하는 방식입니다. 이를 통해 가상화에 필요한 리소스를 줄일 수 있습니다.

### 2.2 Docker 설치

Docker를 설치하기 위해서는 우선 Docker를 설치할 서버에 접속해야 합니다. 저는 AWS EC2를 사용하고 있기 때문에 EC2에 접속하겠습니다.

EC2에 접속하기 위해서는 EC2 인스턴스의 키를 이용해 접속해야 합니다. EC2 인스턴스를 생성할 때 키를 생성하고, 해당 키를 이용해 접속하면 됩니다.

```bash
ssh -i <키 경로> <EC2 인스턴스 주소>
```

저는 다음과 같이 접속했습니다.

```bash
ssh -i ~/.ssh/blog.pem
```

접속이 완료되면 Docker를 설치합니다.

```bash
sudo yum install docker
```

설치가 완료되면 Docker를 실행합니다.

```bash
sudo service docker start
```

Docker가 정상적으로 실행되었는지 확인합니다.

```bash
sudo docker run hello-world
```

다음과 같은 메시지가 출력되면 정상적으로 설치가 완료된 것입니다.

```bash
Hello from Docker!
This message shows that your installation appears to be working correctly.
...
```

### 2.3 Dockerfile 작성

Dockerfile은 Docker 이미지를 만들기 위한 설정 파일입니다. Dockerfile을 작성하기 위해서는 Dockerfile이 위치할 디렉토리에 이동해야 합니다.

```bash
cd <Dockerfile이 위치할 디렉토리>
```

저는 다음과 같이 Dockerfile을 작성했습니다.

```dockerfile
FROM node:14.17.6-alpine3.14

WORKDIR /app

COPY package.json ./

RUN npm install

COPY . .

EXPOSE 3000

CMD ["npm", "start"]
```

Dockerfile을 작성하는 방법에 대해 자세히 알고 싶다면 [Dockerfile reference](https://docs.docker.com/engine/reference/builder/)를 참고하시기 바랍니다.

### 2.4 Docker 이미지 빌드

Dockerfile을 작성했다면 Docker 이미지를 빌드해야 합니다. Docker 이미지를 빌드하기 위해서는 Dockerfile이 위치한 디렉토리에서 다음 명령어를 실행합니다.

```bash
sudo docker build -t <이미지 이름>:<태그> .
```

저는 다음과 같이 Docker 이미지를 빌드했습니다.

```bash
sudo docker build -t blog:1.0 .
```

Docker 이미지가 정상적으로 빌드되었는지 확인합니다.

```bash
sudo docker images
```

다음과 같이 Docker 이미지가 출력되면 정상적으로 빌드된 것입니다.

```bash
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
blog                1.0                 0f2b6b2b2b2b        2 minutes ago       172MB
```

### 2.5 Docker 컨테이너 실행

Docker 이미지를 빌드했다면 Docker 컨테이너를 실행해야 합니다. Docker 컨테이너를 실행하기 위해서는 다음 명령어를 실행합니다.

```bash
sudo docker run -d -p <호스트 포트>:<컨테이너 포트> <이미지 이름>:<태그>
```

저는 다음과 같이 Docker 컨테이너를 실행했습니다.

```bash
sudo docker run -d -p 3000:3000 blog:1.0
```

Docker 컨테이너가 정상적으로 실행되었는지 확인합니다.

```bash
sudo docker ps
```

다음과 같이 Docker 컨테이너가 출력되면 정상적으로 실행된 것입니다.

```bash
CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                    NAMES
b2b0b0b2b2b2   blog:1.0  "docker-entrypoint.s…"   2 minutes ago    Up 2 minutes
```

### 2.6 Docker 컨테이너 접속

Docker 컨테이너를 실행했다면 Docker 컨테이너에 접속해야 합니다. Docker 컨테이너에 접속하기 위해서는 다음 명령어를 실행합니다.

```bash
sudo docker exec -it <컨테이너 ID> /bin/sh
```

저는 다음과 같이 Docker 컨테이너에 접속했습니다.

```bash
sudo docker exec -it b2b0b0b2b2b2 /bin/sh
```

Docker 컨테이너에 정상적으로 접속되었는지 확인합니다.

```bash
ls
```

다음과 같이 Docker 컨테이너의 파일들이 출력되면 정상적으로 접속된 것입니다.

```bash
Dockerfile  README.md  node_modules  package-lock.json  package.json  pages  public  src
```

### 2.7 Docker 컨테이너 종료

Docker 컨테이너를 종료하기 위해서는 다음 명령어를 실행합니다.

```bash
sudo docker stop <컨테이너 ID>
```

저는 다음과 같이 Docker 컨테이너를 종료했습니다.

```bash
sudo docker stop b2b0b0b2b2b2
```

Docker 컨테이너가 정상적으로 종료되었는지 확인합니다.

```bash
sudo docker ps
```

다음과 같이 Docker 컨테이너가 출력되지 않으면 정상적으로 종료된 것입니다.

```bash
CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                    NAMES
```

## 3. Github Actions

### 3.1 Github Actions란?

Github Actions는 Github에서 제공하는 CI/CD 서비스입니다. Github Actions를 이용하면 Github에서 제공하는 다양한 CI/CD 기능을 사용할 수 있습니다.

### 3.2 Github Actions 설정

Github Actions를 사용하기 위해서는 Github Actions 설정 파일을 작성해야 합니다. Github Actions 설정 파일을 작성하기 위해서는 Github 저장소의 `.github/workflows` 디렉토리에 이동해야 합니다.

저는 다음과 같이 Github Actions 설정 파일을 작성했습니다.

````yaml
name: Deploy

on:
  push:
    branches:
      - main

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout
            uses: actions/checkout@v2

        - name: Build
            uses: docker/build-push-action@v2
            with:
            context: .
            file: ./Dockerfile
            push: false
            tags: blog:1.0

        - name: Deploy
            uses: appleboy/ssh-action@master
            with:
            host: <EC2 인스턴스 주소>
            username: <EC2 인스턴스 접속 계정>
            key: ${{ secrets.SSH_KEY }}
            script: |
                sudo docker stop b2b0b0b2b2b2
                sudo docker rm b2b0b0b2b2b2
                sudo docker run -d -p 3000:3000 blog:1.0
    ```
````

Github Actions 설정 파일을 작성하는 방법에 대해 자세히 알고 싶다면 [Workflow syntax for GitHub Actions](https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions)를 참고하시기 바랍니다.

### 3.3 Github Actions Secrets 설정

Github Actions 설정 파일을 작성했다면 Github Actions Secrets를 설정해야 합니다. Github Actions Secrets를 설정하기 위해서는 Github 저장소의 `Settings` 탭에 이동해야 합니다.

저는 다음과 같이 Github Actions Secrets를 설정했습니다.

![Github Actions Secrets 설정](./images/1.png)

### 3.4 Github Actions 실행

Github Actions 설정 파일을 작성했다면 Github Actions를 실행해야 합니다. Github Actions를 실행하기 위해서는 Github 저장소의 `Actions` 탭에 이동해야 합니다.

저는 다음과 같이 Github Actions를 실행했습니다.

![Github Actions 실행](./images/2.png)

Github Actions가 정상적으로 실행되었는지 확인합니다.

![Github Actions 실행 결과](./images/3.png)

## 4. AWS EC2

### 4.1 AWS EC2란?

AWS EC2는 AWS에서 제공하는 클라우드 컴퓨팅 서비스입니다. AWS EC2를 이용하면 가상 서버를 생성하고, 관리할 수 있습니다.

### 4.2 AWS EC2 인스턴스 생성

AWS EC2를 사용하기 위해서는 AWS EC2 인스턴스를 생성해야 합니다. AWS EC2 인스턴스를 생성하기 위해서는 AWS EC2 대시보드에 이동해야 합니다.

저는 다음과 같이 AWS EC2 인스턴스를 생성했습니다.

![AWS EC2 인스턴스 생성](./images/4.png)

### 4.3 AWS EC2 인스턴스 접속

AWS EC2 인스턴스를 생성했다면 AWS EC2 인스턴스에 접속해야 합니다. AWS EC2 인스턴스에 접속하기 위해서는 AWS EC2 인스턴스의 키를 이용해 접속해야 합니다.

저는 다음과 같이 AWS EC2 인스턴스에 접속했습니다.

```bash
ssh -i ~/.ssh/blog.pem
```

# 접속이 완료되면 다음과 같은 메시지가 출력됩니다.

    ```bash
    Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-1051-aws x86_64)

    * Documentation:  https://help.ubuntu.com
    * Management:     https://landscape.canonical.com
    * Support:        https://ubuntu.com/advantage

    System information as of Tue Oct  5 02:30:01 UTC 2021

    System load:  0.0               Processes:             108
    Usage of /:   9.1% of 7.69GB   Users logged in:       0
    Memory usage: 11%               IPv4 address for eth0:
    Swap usage:   0%                IPv6 address for eth0: 2600:1f18:1e9:8c00:2c:29ff:fe0a:2c1c

    * Introducing self-healing high availability clusters in MicroK8s.
      Simple, hardened, Kubernetes for production, from RaspberryPi to DC.

      https://microk8s.io/high-availability

    0 updates can be installed immediately.
    0 of these updates are security updates.

    Last login: Tue Oct  5 02:29:59 2021 from
    ubuntu@ip-172-31-39-111:~$
    ```

### 4.4 AWS EC2 인스턴스 Docker 설치

AWS EC2 인스턴스에 접속했다면 Docker를 설치해야 합니다. Docker를 설치하기 위해서는 다음 명령어를 실행합니다.

```bash
sudo yum install docker
```

설치가 완료되면 Docker를 실행합니다.

```bash
sudo service docker start
```

Docker가 정상적으로 실행되었는지 확인합니다.

```bash
sudo docker run hello-world
```

다음과 같은 메시지가 출력되면 정상적으로 설치가 완료된 것입니다.

```bash
Hello from Docker!
This message shows that your installation appears to be working correctly.
...
```

### 4.5 AWS EC2 인스턴스 Docker 이미지 빌드

AWS EC2 인스턴스에 Docker를 설치했다면 Docker 이미지를 빌드해야 합니다. Docker 이미지를 빌드하기 위해서는 Dockerfile이 위치한 디렉토리에서 다음 명령어를 실행합니다.

```bash
sudo docker build -t <이미지 이름>:<태그> .
```

저는 다음과 같이 Docker 이미지를 빌드했습니다.

```bash
sudo docker build -t blog:1.0 .
```

Docker 이미지가 정상적으로 빌드되었는지 확인합니다.

```bash
sudo docker images
```

다음과 같이 Docker 이미지가 출력되면 정상적으로 빌드된 것입니다.

```bash
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
blog                1.0                 0f2b6b2b2b2b        2 minutes ago       172MB
```

### 4.6 AWS EC2 인스턴스 Docker 컨테이너 실행

Docker 이미지를 빌드했다면 Docker 컨테이너를 실행해야 합니다. Docker 컨테이너를 실행하기 위해서는 다음 명령어를 실행합니다.

```bash
sudo docker run -d -p <호스트 포트>:<컨테이너 포트> <이미지 이름>:<태그>
```

저는 다음과 같이 Docker 컨테이너를 실행했습니다.

```bash
sudo docker run -d -p 3000:3000 blog:1.0
```

Docker 컨테이너가 정상적으로 실행되었는지 확인합니다.

```bash
sudo docker ps
```

다음과 같이 Docker 컨테이너가 출력되면 정상적으로 실행된 것입니다.

```bash
CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                    NAMES
b2b0b0b2b2b2   blog:1.0  "docker-entrypoint.s…"   2 minutes ago    Up 2 minutes
```

### 4.7 AWS EC2 인스턴스 Docker 컨테이너 접속

Docker 컨테이너를 실행했다면 Docker 컨테이너에 접속해야 합니다. Docker 컨테이너에 접속하기 위해서는 다음 명령어를 실행합니다.

```bash
sudo docker exec -it <컨테이너 ID> /bin/sh
```

저는 다음과 같이 Docker 컨테이너에 접속했습니다.

```bash
sudo docker exec -it b2b0b0b2b2b2 /bin/sh
```

Docker 컨테이너에 정상적으로 접속되었는지 확인합니다.

```bash
ls
```

다음과 같이 Docker 컨테이너의 파일들이 출력되면 정상적으로 접속된 것입니다.

```bash
Dockerfile  README.md  node_modules  package-lock.json  package.json  pages  public  src
```
